<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sass Tracker ‚ú®</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
    .reverted-entry {
      opacity: 0.6;
      background: rgba(0, 0, 0, 0.05);
      position: relative;
    }
    .reverted-entry::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 2px;
      background: #ef4444;
      transform: translateY(-50%);
    }
    .revert-log {
      background: linear-gradient(135deg, rgba(251, 146, 60, 0.1) 0%, rgba(249, 115, 22, 0.1) 100%);
      border-left: 3px solid #f97316;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    // Lucide icons
    const Crown = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/>
      </svg>`;
    
    const Wind = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/>
        <path d="M9.6 4.6A2 2 0 1 1 11 8H2"/>
        <path d="M12.6 19.4A2 2 0 1 0 14 16H2"/>
      </svg>`;
    
    const Flame = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
      </svg>`;
    
    const Users = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M22 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>`;
    
    const Trophy = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/>
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/>
        <path d="M4 22h16"/>
        <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/>
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/>
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/>
      </svg>`;

    const AlertCircle = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="8" x2="12" y2="12"/>
        <line x1="12" y1="16" x2="12.01" y2="16"/>
      </svg>`;

    const DollarSign = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <line x1="12" y1="1" x2="12" y2="23"/>
        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
      </svg>`;

    const CheckCircle = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
        <polyline points="22 4 12 14.01 9 11.01"/>
      </svg>`;

    const RotateCcw = ({ size = 24, className = '' }) => `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${className}">
        <polyline points="1 4 1 10 7 10"/>
        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
      </svg>`;

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDpV7zymYf8io3C1Uq23endekHyjQJmLAQ",
      authDomain: "sass-tracker-99ab5.firebaseapp.com",
      databaseURL: "https://sass-tracker-99ab5-default-rtdb.firebaseio.com",
      projectId: "sass-tracker-99ab5",
      storageBucket: "sass-tracker-99ab5.firebasestorage.app",
      messagingSenderId: "42632150330",
      appId: "1:42632150330:web:9c3022a9df30458face403",
      measurementId: "G-QRK5N76DNW"
    };

    // Quick Reason Presets - Categorized
    const quickReasons = {
      good: {
        top5: [
          { emoji: 'üëç', label: 'Helpful' },
          { emoji: 'ü§ù', label: 'Sharing' },
          { emoji: 'üí¨', label: 'Great Attitude' },
          { emoji: 'üßπ', label: 'Finished Chores' },
          { emoji: '‚ù§Ô∏è', label: 'Kind Moment' }
        ],
        helping: [
          { emoji: 'üåü', label: 'Super Helpful' },
          { emoji: 'üíó', label: 'Kind Words' },
          { emoji: 'ü§ù', label: 'Sharing' },
          { emoji: 'üß∏', label: 'Gentle w/ Sibling' }
        ],
        responsibility: [
          { emoji: 'üßº', label: 'Clean-up Hero' },
          { emoji: 'üìö', label: 'Homework Win' },
          { emoji: 'üßπ', label: 'Chores Done' },
          { emoji: '‚úÖ', label: 'Task Complete' }
        ],
        attitude: [
          { emoji: 'üòá', label: 'Calm & Respectful' },
          { emoji: 'üëÇ', label: 'Listening Champ' },
          { emoji: 'üôè', label: 'Great Manners' },
          { emoji: 'üíØ', label: 'Honest Moment' }
        ]
      },
      sass: {
        top5: [
          { emoji: 'üòë', label: 'Talking Back' },
          { emoji: 'üö´', label: 'Not Listening' },
          { emoji: 'üò§', label: 'Attitude Burst' },
          { emoji: 'üóëÔ∏è', label: 'Didn\'t Clean Up' },
          { emoji: 'ü•ä', label: 'Sibling Fight' }
        ],
        attitude: [
          { emoji: 'üòë', label: 'Talking Back' },
          { emoji: 'üôÑ', label: 'Eye Rolling' },
          { emoji: 'üòí', label: 'Snarky Tone' },
          { emoji: 'üò§', label: 'Sass Attack' }
        ],
        rules: [
          { emoji: 'üö´', label: 'Not Listening' },
          { emoji: '‚ö†Ô∏è', label: 'Rule Break' },
          { emoji: '‚ùå', label: 'Task Refusal' },
          { emoji: '‚è∞', label: 'Bedtime Battle' }
        ],
        conflict: [
          { emoji: 'ü•ä', label: 'Sibling Fight' },
          { emoji: 'ü§¨', label: 'Instigating' },
          { emoji: 'üó£Ô∏è', label: 'Interrupting' },
          { emoji: 'üò†', label: 'Not Sharing' }
        ],
        responsibility: [
          { emoji: 'üóëÔ∏è', label: 'Mess Left Behind' },
          { emoji: 'üßπ', label: 'Didn\'t Clean Up' },
          { emoji: 'üö´', label: 'Chore Refusal' },
          { emoji: 'üì±', label: 'Screen Time Fight' }
        ]
      }
    };

    // Consequences for sass debt (when they owe)
    const consequences = [
      { id: 'chore', name: 'Extra Chore', cost: 1, icon: 'üßπ' },
      { id: 'dish', name: 'Wash Dishes', cost: 2, icon: 'üçΩÔ∏è' },
      { id: 'room', name: 'Clean Room', cost: 3, icon: 'üõèÔ∏è' },
      { id: 'yard', name: 'Yard Work', cost: 2, icon: 'üå±' },
      { id: 'dollar', name: 'Pay $1', cost: 1, icon: 'üíµ' },
      { id: 'screen', name: 'Lose Screen Time', cost: 2, icon: 'üì±' },
      { id: 'dessert', name: 'No Dessert', cost: 1, icon: 'üç∞' },
      { id: 'early-bed', name: 'Early Bedtime', cost: 2, icon: 'üò¥' }
    ];

    // Rick Ross Grunts (just for fun, doesn't affect sass scores!)
    const gruntTypes = [
      { id: 'unh', sound: 'UNH!', emoji: 'üòé', label: 'Cool', color: 'from-blue-500 to-cyan-500' },
      { id: 'woo', sound: 'WOO!', emoji: 'üéâ', label: 'Happy', color: 'from-yellow-500 to-orange-500' },
      { id: 'ayy', sound: 'AYYY!', emoji: 'üî•', label: 'Fired Up', color: 'from-red-500 to-orange-500' },
      { id: 'huh', sound: 'HUH!', emoji: 'üò§', label: 'Angry', color: 'from-purple-500 to-pink-500' },
      { id: 'boss', sound: 'BOSS!', emoji: 'üëë', label: 'Feeling Bossy', color: 'from-yellow-400 to-yellow-600' },
      { id: 'mmm', sound: 'MMMM!', emoji: 'üòã', label: 'Tasty', color: 'from-green-500 to-emerald-500' }
    ];

    // App State
    let state = {
      data: {
        events: [],
        currentScores: { nayra: 0, ezra: 0, justin: 0 },
        lifetimeScores: { nayra: 0, ezra: 0, justin: 0 },
        payoffs: [],
        snapshots: [],
        lastPayoutTimestamp: 0,
        grunts: []
      },
      activeTab: 'today',
      noteModal: null,
      payoffModal: null,
      snapshotModal: false,
      snapshotNote: '',
      note: '',
      selectedReason: '',
      selectedCategory: 'top5',
      currentUser: null,
      showUserSelect: true,
      roomId: '',
      isConnected: false,
      selectedSnapshot: null,
      showPayoutModal: false,
      payoutLabel: '',
      showGruntModal: false
    };

    const players = [
      { id: 'nayra', name: 'Nayra', icon: Crown, color: 'bg-purple-500' },
      { id: 'ezra', name: 'Ezra', icon: Wind, color: 'bg-blue-500' },
      { id: 'justin', name: 'Justin', icon: Flame, color: 'bg-orange-500' }
    ];

    // Helper Functions
    const getTodayString = () => new Date().toISOString().split('T')[0];

    const getCurrentScores = () => {
      const scores = { nayra: 0, ezra: 0, justin: 0 };
      const lastPayout = state.data.lastPayoutTimestamp || 0;
      
      // Only count events since the last payout that aren't reverted
      state.data.events
        .filter(e => e.timestamp > lastPayout && !e.reverted)
        .forEach(e => {
          scores[e.receiverId] += e.value;
        });
      
      return scores;
    };

    const updateLifetimeScores = () => {
      // Calculate lifetime scores from all non-reverted events
      const lifetime = { nayra: 0, ezra: 0, justin: 0 };
      state.data.events
        .filter(e => !e.reverted)
        .forEach(e => {
          lifetime[e.receiverId] += e.value;
        });
      return lifetime;
    };

    const getTodayEvents = () => {
      const today = getTodayString();
      return state.data.events.filter(e => e.date === today);
    };

    const formatDateTime = (timestamp) => {
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };

    const getSassLevel = (score) => {
      if (score === 0) return { label: 'Clean Slate', color: 'text-gray-600', emoji: 'üòä' };
      if (score <= 2) return { label: 'Minor Sass', color: 'text-yellow-600', emoji: 'üò¨' };
      if (score <= 5) return { label: 'Moderate Sass', color: 'text-orange-600', emoji: 'üò§' };
      if (score <= 10) return { label: 'High Sass', color: 'text-red-600', emoji: 'üî•' };
      return { label: 'SASS OVERLOAD', color: 'text-red-800', emoji: 'üí•' };
    };

    // Firebase Connection
    let firebaseDB = null;

    const initFirebase = async () => {
      if (!state.roomId || !state.isConnected) return;

      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getDatabase, ref, onValue, set } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js');
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const roomRef = ref(db, `rooms/${state.roomId}`);

        onValue(roomRef, (snapshot) => {
          const val = snapshot.val();
          if (val) {
            // Migration: Ensure all new fields exist and add IDs to events
            const migratedData = {
              events: (val.events || []).map((event, index) => ({
                ...event,
                id: event.id || `event_${event.timestamp || Date.now()}_${index}`,
                reverted: event.reverted || false,
                revertedBy: event.revertedBy || null,
                revertedAt: event.revertedAt || null,
                isRevertLog: event.isRevertLog || false
              })),
              currentScores: val.currentScores || { nayra: 0, ezra: 0, justin: 0 },
              lifetimeScores: val.lifetimeScores || { nayra: 0, ezra: 0, justin: 0 },
              payoffs: val.payoffs || [],
              snapshots: val.snapshots || [],
              lastPayoutTimestamp: val.lastPayoutTimestamp || 0,
              grunts: val.grunts || []
            };
            state.data = migratedData;
            
            // Save migrated data back if fields were added
            if (!val.events?.every(e => e.id && e.reverted !== undefined)) {
              set(roomRef, migratedData);
            }
          } else {
            const initialData = {
              events: [],
              currentScores: { nayra: 0, ezra: 0, justin: 0 },
              lifetimeScores: { nayra: 0, ezra: 0, justin: 0 },
              payoffs: [],
              snapshots: [],
              lastPayoutTimestamp: 0,
              grunts: []
            };
            set(roomRef, initialData);
            state.data = initialData;
          }
          render();
        });

        firebaseDB = { db, roomRef, set, ref };
      } catch (error) {
        console.error('Firebase error:', error);
      }
    };

    // Add Sass Event
    const handleAddSassEvent = async (receiverId, value, eventNote = '', reason = '') => {
      if (!state.currentUser) {
        alert('Please select who you are first!');
        return;
      }

      const newEvent = {
        id: `event_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        timestamp: Date.now(),
        giverId: state.currentUser,
        receiverId,
        value,
        note: eventNote,
        reason: reason,
        date: getTodayString(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        reverted: false,
        revertedBy: null,
        revertedAt: null,
        isRevertLog: false
      };

      const updatedEvents = [newEvent, ...state.data.events];
      
      // Calculate lifetime scores from all non-reverted events
      const lifetimeScores = { nayra: 0, ezra: 0, justin: 0 };
      updatedEvents.filter(e => !e.reverted).forEach(e => {
        lifetimeScores[e.receiverId] += e.value;
      });

      const newData = {
        ...state.data,
        events: updatedEvents,
        lifetimeScores: lifetimeScores
      };

      if (state.isConnected && firebaseDB) {
        try {
          await firebaseDB.set(firebaseDB.roomRef, newData);
        } catch (error) {
          state.data = newData;
          render();
        }
      } else {
        state.data = newData;
        render();
      }

      state.noteModal = null;
      state.note = '';
      state.selectedReason = '';
      render();
    };

    // Revert Sass Event
    const handleRevertSassEvent = async (eventId) => {
      const event = state.data.events.find(e => e.id === eventId);
      if (!event) return;
      
      if (event.reverted) {
        alert('‚ö†Ô∏è This entry has already been reverted!');
        return;
      }

      if (event.isRevertLog) {
        alert('‚ö†Ô∏è Cannot revert a revert log entry!');
        return;
      }

      const giver = players.find(p => p.id === event.giverId);
      const receiver = players.find(p => p.id === event.receiverId);
      
      const confirmMsg = `üîÑ Revert this sass entry?\n\n${giver?.name || 'Unknown'} gave ${receiver?.name || 'Unknown'} ${event.value > 0 ? '+' : ''}${event.value} sass\nReason: ${event.reason || 'No reason'}\n${event.note ? `Note: "${event.note}"` : ''}\n\nThis will undo the sass points and create a revert log entry.`;
      
      if (!confirm(confirmMsg)) return;

      // Mark original event as reverted
      const updatedEvents = state.data.events.map(e => 
        e.id === eventId ? { 
          ...e, 
          reverted: true, 
          revertedBy: state.currentUser, 
          revertedAt: Date.now() 
        } : e
      );

      // Create revert log entry
      const revertLogEntry = {
        id: `revert_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        timestamp: Date.now(),
        giverId: state.currentUser,
        receiverId: event.receiverId,
        value: -event.value,
        note: `Reverted: "${event.reason || 'No reason'}" (Originally by ${giver?.name || 'Unknown'})`,
        reason: 'üîÑ SASS REVERTED',
        date: getTodayString(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        reverted: false,
        revertedBy: null,
        revertedAt: null,
        isRevertLog: true,
        originalEventId: eventId
      };

      updatedEvents.unshift(revertLogEntry);

      // Recalculate lifetime scores from all non-reverted events
      const lifetimeScores = { nayra: 0, ezra: 0, justin: 0 };
      updatedEvents.filter(e => !e.reverted).forEach(e => {
        lifetimeScores[e.receiverId] += e.value;
      });

      const newData = {
        ...state.data,
        events: updatedEvents,
        lifetimeScores: lifetimeScores
      };

      if (state.isConnected && firebaseDB) {
        try {
          await firebaseDB.set(firebaseDB.roomRef, newData);
        } catch (error) {
          state.data = newData;
          render();
        }
      } else {
        state.data = newData;
        render();
      }

      render();
    };

    // Add Grunt (Rick Ross style - just for fun!)
    const handleAddGrunt = async (playerId, gruntType) => {
      const grunt = {
        id: Date.now(),
        timestamp: Date.now(),
        playerId,
        gruntId: gruntType.id,
        sound: gruntType.sound,
        emoji: gruntType.emoji,
        label: gruntType.label,
        date: getTodayString(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
      };

      const newData = {
        ...state.data,
        grunts: [grunt, ...state.data.grunts]
      };

      if (state.isConnected && firebaseDB) {
        try {
          await firebaseDB.set(firebaseDB.roomRef, newData);
        } catch (error) {
          state.data = newData;
          render();
        }
      } else {
        state.data = newData;
        render();
      }

      state.showGruntModal = false;
      
      // Show epic grunt notification
      const player = players.find(p => p.id === playerId);
      setTimeout(() => {
        alert(`${gruntType.emoji} ${gruntType.sound} ${gruntType.emoji}\n\n${player.name} dropped a ${gruntType.label} grunt!\n\nNo sass points affected - just pure vibes! üòé`);
      }, 100);
      
      render();
    };

    // Make Payout / End Round
    const handleMakePayout = async (label) => {
      const currentScores = getCurrentScores();
      const now = Date.now();
      
      const payout = {
        id: now,
        timestamp: now,
        date: getTodayString(),
        label: label || 'Unnamed Round',
        totals: { ...currentScores }
      };
      
      const newData = {
        ...state.data,
        snapshots: [payout, ...state.data.snapshots],
        lastPayoutTimestamp: now
      };
      
      if (state.isConnected && firebaseDB) {
        try {
          await firebaseDB.set(firebaseDB.roomRef, newData);
        } catch (error) {
          state.data = newData;
          render();
        }
      } else {
        state.data = newData;
        render();
      }
      
      state.showPayoutModal = false;
      state.payoutLabel = '';
      
      // Show success message
      const winner = players.reduce((best, player) => 
        currentScores[player.id] < currentScores[best.id] ? player : best
      );
      
      setTimeout(() => {
        alert(`üèÅ Round Complete!\n\n"${label || 'Round'}"\n\nüëë Winner: ${winner.name} (${currentScores[winner.id]} sass)\n\nAll meters reset to 0! Fresh start! üéâ`);
      }, 100);
      
      render();
    };

    // Pay Off Sass (complete a consequence)
    const handlePayOffSass = async (playerId, consequence) => {
      const currentScore = getCurrentScores()[playerId];
      
      if (currentScore <= 0) {
        alert('No sass debt to pay off!');
        return;
      }

      if (currentScore < consequence.cost) {
        alert(`Consequence too big! Only ${currentScore} sass points owed.`);
        return;
      }

      const payoff = {
        id: Date.now(),
        timestamp: Date.now(),
        playerId,
        consequenceId: consequence.id,
        consequenceName: consequence.name,
        cost: consequence.cost,
        date: getTodayString()
      };

      // Add event that reduces sass (negative value)
      const payoffEvent = {
        id: `payoff_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        timestamp: Date.now(),
        giverId: 'system',
        receiverId: playerId,
        value: -consequence.cost,
        note: `Completed: ${consequence.name}`,
        reason: 'Sass Payoff',
        date: getTodayString(),
        time: new Date().toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
        reverted: false,
        revertedBy: null,
        revertedAt: null,
        isRevertLog: false
      };

      const updatedEvents = [payoffEvent, ...state.data.events];
      
      // Recalculate lifetime scores
      const lifetimeScores = { nayra: 0, ezra: 0, justin: 0 };
      updatedEvents.filter(e => !e.reverted).forEach(e => {
        lifetimeScores[e.receiverId] += e.value;
      });

      const newData = {
        ...state.data,
        payoffs: [payoff, ...state.data.payoffs],
        events: updatedEvents,
        lifetimeScores: lifetimeScores
      };

      if (state.isConnected && firebaseDB) {
        try {
          await firebaseDB.set(firebaseDB.roomRef, newData);
        } catch (error) {
          state.data = newData;
          render();
        }
      } else {
        state.data = newData;
        render();
      }

      state.payoffModal = null;
      render();
    };

    // Render Function
    const render = () => {
      const app = document.getElementById('app');
      const currentScores = getCurrentScores();
      const todayEvents = getTodayEvents();

      app.innerHTML = `
        <div class="min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 p-4">
          <div class="max-w-4xl mx-auto">
            
            ${state.showUserSelect ? `
              <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl p-8 max-w-md w-full">
                  <div class="text-center mb-6">
                    ${Users({ size: 48, className: 'mx-auto text-purple-500 mb-4' })}
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Sass Tracker</h2>
                    <p class="text-gray-600">Track sass & pay it off!</p>
                  </div>

                  ${!state.isConnected ? `
                    <div class="space-y-4">
                      <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                        <h4 class="font-semibold text-blue-900 mb-2">üè† Create or Join a Room</h4>
                        <p class="text-sm text-blue-800">
                          Rooms let your family sync sass tracking across all devices in real-time.
                        </p>
                      </div>
                      
                      <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                          Room Name
                        </label>
                        <input
                          type="text"
                          id="roomIdInput"
                          value="${state.roomId}"
                          placeholder="e.g., smith-family-2024"
                          class="w-full p-3 border rounded-lg"
                        />
                        <p class="text-xs text-gray-500 mt-2">
                          üí° <strong>Tip:</strong> Use a unique name like "smith-family-2024" or "jones-household"
                        </p>
                      </div>

                      <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                        <p class="text-xs text-yellow-800">
                          ‚ö†Ô∏è <strong>Important:</strong> Anyone with this room name can access your data. 
                          Make it unique and only share with family!
                        </p>
                      </div>

                      <button
                        onclick="connectToRoom()"
                        class="w-full py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-lg"
                      >
                        üöÄ Create/Join Room
                      </button>
                      
                      <div class="text-center">
                        <button
                          onclick="skipFirebase()"
                          class="text-sm text-gray-600 hover:text-purple-600 underline"
                        >
                          Skip - Use Local Mode (No Sync)
                        </button>
                      </div>
                    </div>
                  ` : `
                    <div class="space-y-2">
                      ${players.map(player => `
                        <button
                          onclick="selectUser('${player.id}')"
                          class="w-full flex items-center gap-3 p-4 rounded-lg border-2 ${
                            state.currentUser === player.id ? 'border-purple-500 bg-purple-50' : 'border-gray-200'
                          }"
                        >
                          <div class="${player.color} p-2 rounded-lg">
                            ${player.icon({ size: 24, className: 'text-white' })}
                          </div>
                          <span class="text-lg font-semibold">${player.name}</span>
                        </button>
                      `).join('')}
                    </div>
                  `}
                </div>
              </div>
            ` : ''}

            ${state.currentUser ? `
              <div class="flex justify-between items-center mb-4">
                <div class="bg-white rounded-lg shadow-md px-4 py-2">
                  <span class="text-sm text-gray-600">Logged in: </span>
                  <span class="font-bold">${players.find(p => p.id === state.currentUser)?.name}</span>
                </div>
                <button onclick="switchUser()" class="text-sm text-purple-600 font-semibold">Switch</button>
              </div>
            ` : ''}

            <div class="text-center mb-6">
              <h1 class="text-4xl font-bold text-gray-800 mb-2">‚ú® Sass Tracker ‚ú®</h1>
              <p class="text-gray-600">Keep sass low, pay it off with chores!</p>
            </div>

            <!-- How It Works -->
            <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-xl p-6 mb-6 shadow-lg">
              <h3 class="font-bold text-gray-800 mb-3 text-center">üìñ How It Works</h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-white rounded-lg p-4 text-center">
                  <div class="text-3xl mb-2">üî•</div>
                  <div class="text-sm font-semibold text-red-600">+1 Sass</div>
                  <div class="text-xs text-gray-600 mt-1">Bad behavior<br/>(Talking back, attitude)</div>
                  <div class="text-xs text-red-800 mt-2 font-bold">Creates debt!</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center">
                  <div class="text-3xl mb-2">‚≠ê</div>
                  <div class="text-sm font-semibold text-green-600">‚àí1 Apolo-Sass</div>
                  <div class="text-xs text-gray-600 mt-1">Good behavior<br/>(Helpful, respectful)</div>
                  <div class="text-xs text-green-800 mt-2 font-bold">Pays down debt!</div>
                </div>
              </div>
              <div class="mt-4 p-3 bg-white rounded-lg">
                <p class="text-xs text-center text-gray-700">
                  üí° <strong>Pay off sass with:</strong> Chores, money, losing privileges | üîÑ <strong>New!</strong> Revert mistakes
                </p>
              </div>
            </div>

            <div class="flex gap-2 mb-6 bg-white rounded-lg p-2 shadow-md">
              <button
                onclick="switchTab('today')"
                class="flex-1 py-3 rounded-md font-semibold text-sm ${
                  state.activeTab === 'today' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-gray-600'
                }"
              >
                Today
              </button>
              <button
                onclick="switchTab('payoff')"
                class="flex-1 py-3 rounded-md font-semibold text-sm ${
                  state.activeTab === 'payoff' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-gray-600'
                }"
              >
                Pay Off
              </button>
              <button
                onclick="switchTab('stats')"
                class="flex-1 py-3 rounded-md font-semibold text-sm ${
                  state.activeTab === 'stats' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-gray-600'
                }"
              >
                Stats
              </button>
              <button
                onclick="switchTab('history')"
                class="flex-1 py-3 rounded-md font-semibold text-sm ${
                  state.activeTab === 'history' ? 'bg-gradient-to-r from-purple-500 to-pink-500 text-white' : 'text-gray-600'
                }"
              >
                History
              </button>
            </div>

            ${state.activeTab === 'today' ? `
              <div class="space-y-6">
                ${players.map(player => {
                  const score = currentScores[player.id];
                  const sassLevel = getSassLevel(score);
                  const maxRange = 20;
                  const angle = Math.max(-90, Math.min(90, (score / maxRange) * 90));
                  
                  return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                      <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center gap-3">
                          <div class="${player.color} p-3 rounded-lg">
                            ${player.icon({ size: 28, className: 'text-white' })}
                          </div>
                          <div>
                            <h2 class="text-2xl font-bold text-gray-800">${player.name}</h2>
                            <p class="text-sm ${sassLevel.color} font-semibold">
                              ${sassLevel.emoji} ${sassLevel.label}
                            </p>
                          </div>
                        </div>
                        ${score > 0 ? `
                          <div class="text-center">
                            <div class="text-3xl font-bold text-red-600">${score}</div>
                            <div class="text-xs text-red-600">sass owed</div>
                          </div>
                        ` : score < 0 ? `
                          <div class="text-center">
                            <div class="text-3xl font-bold text-green-600">${Math.abs(score)}</div>
                            <div class="text-xs text-green-600">credit!</div>
                          </div>
                        ` : `
                          <div class="text-center">
                            <div class="text-3xl">üòä</div>
                            <div class="text-xs text-gray-600">All good!</div>
                          </div>
                        `}
                      </div>
                      
                      <div class="flex flex-col items-center mb-6">
                        <div class="relative w-72 h-36">
                          <svg viewBox="0 0 240 120" class="w-full h-full">
                            <!-- Background arc -->
                            <path d="M 30 105 A 90 90 0 0 1 210 105" fill="none" stroke="#e5e7eb" stroke-width="20" stroke-linecap="round"/>
                            
                            <!-- Green zone (left side) -->
                            <path d="M 30 105 A 90 90 0 0 1 120 15" fill="none" stroke="#10b981" stroke-width="20" stroke-linecap="round" opacity="0.4"/>
                            
                            <!-- Red zone (right side) -->
                            <path d="M 120 15 A 90 90 0 0 1 210 105" fill="none" stroke="#ef4444" stroke-width="20" stroke-linecap="round" opacity="0.4"/>
                            
                            <!-- Tick marks and numbers -->
                            ${[-20, -15, -10, -5, 0, 5, 10, 15, 20].map(num => {
                              const tickAngle = (num / 20) * 90 - 90;
                              const isMain = num % 5 === 0;
                              const tickLength = isMain ? 15 : 8;
                              const innerRadius = 90 - tickLength;
                              const outerRadius = 90;
                              
                              const x1 = 120 + innerRadius * Math.cos((tickAngle * Math.PI) / 180);
                              const y1 = 105 + innerRadius * Math.sin((tickAngle * Math.PI) / 180);
                              const x2 = 120 + outerRadius * Math.cos((tickAngle * Math.PI) / 180);
                              const y2 = 105 + outerRadius * Math.sin((tickAngle * Math.PI) / 180);
                              
                              const textRadius = 90 - 25;
                              const textX = 120 + textRadius * Math.cos((tickAngle * Math.PI) / 180);
                              const textY = 105 + textRadius * Math.sin((tickAngle * Math.PI) / 180);
                              
                              return `
                                <line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}" 
                                      stroke="${isMain ? '#374151' : '#9ca3af'}" 
                                      stroke-width="${isMain ? 2 : 1}"/>
                                ${isMain && num % 10 === 0 ? `
                                  <text x="${textX}" y="${textY}" 
                                        text-anchor="middle" 
                                        dominant-baseline="middle"
                                        font-size="10" 
                                        font-weight="bold"
                                        fill="${num > 0 ? '#dc2626' : num < 0 ? '#059669' : '#6b7280'}">
                                    ${num}
                                  </text>
                                ` : ''}
                              `;
                            }).join('')}
                            
                            <!-- Center circle shadow -->
                            <circle cx="120" cy="105" r="10" fill="#1f2937" opacity="0.2"/>
                            
                            <!-- Needle with shadow -->
                            <g transform="rotate(${angle} 120 105)" filter="url(#needleShadow)">
                              <path d="M 120 105 L 118 100 L 120 30 L 122 100 Z" 
                                    fill="${score >= 0 ? '#dc2626' : '#059669'}" 
                                    stroke="#000" 
                                    stroke-width="0.5"/>
                              <circle cx="120" cy="105" r="8" fill="#374151" stroke="#000" stroke-width="1"/>
                              <circle cx="120" cy="105" r="4" fill="#6b7280"/>
                            </g>
                            
                            <!-- Shadow definition -->
                            <defs>
                              <filter id="needleShadow" x="-50%" y="-50%" width="200%" height="200%">
                                <feGaussianBlur in="SourceAlpha" stdDeviation="1"/>
                                <feOffset dx="1" dy="1" result="offsetblur"/>
                                <feComponentTransfer>
                                  <feFuncA type="linear" slope="0.3"/>
                                </feComponentTransfer>
                                <feMerge>
                                  <feMergeNode/>
                                  <feMergeNode in="SourceGraphic"/>
                                </feMerge>
                              </filter>
                            </defs>
                          </svg>
                          
                          <!-- Digital readout -->
                          <div class="absolute bottom-2 left-0 right-0 flex justify-center">
                            <div class="bg-gray-900 rounded-lg px-4 py-1 shadow-inner border border-gray-700">
                              <p class="text-3xl font-mono font-bold ${score > 0 ? 'text-red-500' : score < 0 ? 'text-green-400' : 'text-gray-400'}" style="text-shadow: 0 0 10px currentColor;">
                                ${score > 0 ? '+' : ''}${score}
                              </p>
                            </div>
                          </div>
                        </div>
                        <p class="text-sm text-gray-500 mt-2 font-semibold">‚ö° SASS METER ‚ö°</p>
                      </div>
                      
                      <div class="flex gap-3">
                        <button
                          onclick="openNoteModal('${player.id}', 1)"
                          class="flex-1 bg-gradient-to-r from-red-500 to-orange-500 text-white py-3 px-6 rounded-lg font-semibold hover:shadow-lg"
                        >
                          +1 Sass
                        </button>
                        <button
                          onclick="openNoteModal('${player.id}', -1)"
                          class="flex-1 bg-gradient-to-r from-green-500 to-emerald-500 text-white py-3 px-6 rounded-lg font-semibold hover:shadow-lg"
                        >
                          ‚àí1 Apolo-Sass
                        </button>
                      </div>

                      <!-- Rick Ross Grunt Button -->
                      <div class="mt-3">
                        <button
                          onclick="openGruntModal('${player.id}')"
                          class="w-full py-2 bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 text-gray-900 rounded-lg font-bold hover:shadow-lg flex items-center justify-center gap-2 border-2 border-yellow-700"
                        >
                          üòé DROP A GRUNT üòé
                        </button>
                      </div>

                      ${score > 0 ? `
                        <div class="mt-4">
                          <button
                            onclick="openPayoffModal('${player.id}')"
                            class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg font-semibold hover:shadow-lg flex items-center justify-center gap-2"
                          >
                            ${CheckCircle({ size: 20, className: 'text-white' })}
                            Pay Off Sass (${score} points owed)
                          </button>
                        </div>
                      ` : ''}
                    </div>
                  `;
                }).join('')}

                ${todayEvents.length > 0 ? `
                  <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Today's Events</h3>
                    <div class="space-y-2">
                      ${todayEvents.map(event => {
                        const giver = players.find(p => p.id === event.giverId);
                        const receiver = players.find(p => p.id === event.receiverId);
                        const isPayoff = event.reason === 'Sass Payoff';
                        const isRevertLog = event.isRevertLog;
                        const isReverted = event.reverted && !isRevertLog;
                        
                        return `
                          <div class="p-3 ${isPayoff ? 'bg-blue-50' : isRevertLog ? 'revert-log' : isReverted ? 'reverted-entry' : 'bg-gray-50'} rounded-lg relative">
                            <div class="flex items-center gap-3 mb-1">
                              <span class="text-sm text-gray-500 min-w-[60px]">${event.time}</span>
                              <div class="flex items-center gap-2 flex-1 flex-wrap">
                                ${!isPayoff ? `
                                  <span class="font-bold text-purple-600">${giver?.name || 'Unknown'}</span>
                                  <span class="text-gray-400">gave</span>
                                ` : ''}
                                <span class="font-bold text-lg ${event.value > 0 ? 'text-red-500' : 'text-green-500'}">
                                  ${event.value > 0 ? '+' : ''}${event.value}
                                </span>
                                ${!isPayoff ? `
                                  <span class="text-gray-400">sass to</span>
                                  <span class="font-bold text-gray-800">${receiver?.name || 'Unknown'}</span>
                                ` : `
                                  <span class="text-gray-400">-</span>
                                  <span class="font-bold text-blue-600">${receiver?.name} paid off sass</span>
                                `}
                                ${event.reason && event.reason !== 'Sass Payoff' ? `
                                  <span class="text-xs ${isRevertLog ? 'bg-orange-100 text-orange-700' : 'bg-purple-100 text-purple-700'} px-2 py-1 rounded-full">
                                    ${event.reason}
                                  </span>
                                ` : ''}
                                ${!isReverted && !isRevertLog && !isPayoff ? `
                                  <button
                                    onclick="revertSassEvent('${event.id}')"
                                    class="ml-auto bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded-lg transition-all flex items-center gap-1"
                                    title="Revert this entry"
                                  >
                                    ${RotateCcw({ size: 14, className: 'inline' })}
                                    Revert
                                  </button>
                                ` : ''}
                              </div>
                            </div>
                            ${event.note ? `
                              <div class="ml-[72px] text-sm text-gray-600 italic">
                                üí¨ "${event.note}"
                              </div>
                            ` : ''}
                            ${isReverted ? `
                              <div class="ml-[72px] text-xs text-yellow-700 font-semibold mt-1">
                                ‚ö†Ô∏è REVERTED by ${players.find(p => p.id === event.revertedBy)?.name || 'Unknown'} at ${new Date(event.revertedAt).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}
                              </div>
                            ` : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}
              </div>
            ` : ''}

            ${state.activeTab === 'payoff' ? `
              <div class="space-y-6">
                ${players.map(player => {
                  const score = currentScores[player.id];
                  const availableConsequences = consequences.filter(c => c.cost <= score);
                  
                  return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                      <div class="flex items-center gap-3 mb-4">
                        <div class="${player.color} p-3 rounded-lg">
                          ${player.icon({ size: 28, className: 'text-white' })}
                        </div>
                        <div>
                          <h2 class="text-2xl font-bold text-gray-800">${player.name}</h2>
                          <p class="text-sm ${score > 0 ? 'text-red-600' : score < 0 ? 'text-green-600' : 'text-gray-600'}">
                            ${score > 0 ? `${score} sass points owed` : score < 0 ? `${Math.abs(score)} credit!` : 'All clear!'}
                          </p>
                        </div>
                      </div>

                      ${score > 0 ? `
                        <div class="mb-4">
                          <h4 class="text-sm font-semibold text-gray-700 mb-3">Available Consequences:</h4>
                          <div class="grid grid-cols-2 gap-3">
                            ${availableConsequences.map(consequence => `
                              <button
                                onclick="payOffSass('${player.id}', ${JSON.stringify(consequence).replace(/"/g, '&quot;')})"
                                class="p-4 border-2 border-gray-200 rounded-lg hover:border-purple-500 hover:bg-purple-50 transition-all text-center"
                              >
                                <div class="text-3xl mb-1">${consequence.icon}</div>
                                <div class="text-sm font-semibold text-gray-800">${consequence.name}</div>
                                <div class="text-xs text-purple-600 font-bold mt-1">-${consequence.cost} sass</div>
                              </button>
                            `).join('')}
                          </div>
                        </div>
                      ` : score === 0 ? `
                        <div class="text-center py-8">
                          <div class="text-5xl mb-2">üéâ</div>
                          <p class="text-gray-600">No sass to pay off!</p>
                        </div>
                      ` : `
                        <div class="text-center py-8">
                          <div class="text-5xl mb-2">‚≠ê</div>
                          <p class="text-green-600 font-semibold">In credit! Keep it up!</p>
                        </div>
                      `}
                    </div>
                  `;
                }).join('')}
              </div>
            ` : ''}

            ${state.activeTab === 'stats' ? `
              <div class="space-y-6">
                <!-- End Round Button -->
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl p-1 shadow-lg">
                  <button
                    onclick="openPayoutModal()"
                    class="w-full bg-white rounded-lg p-4 font-semibold text-gray-800 hover:bg-gray-50 transition-all flex items-center justify-center gap-2"
                  >
                    üèÅ End Round & Make Payout
                  </button>
                </div>

                <!-- Lifetime Sass Leaderboard -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                  <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                    ${Trophy({ size: 24, className: 'text-yellow-500' })}
                    Lifetime Sass Totals
                  </h3>
                  <div class="space-y-3">
                    ${[...players]
                      .sort((a, b) => state.data.lifetimeScores[a.id] - state.data.lifetimeScores[b.id])
                      .map((player, index) => {
                        const lifetimeScore = state.data.lifetimeScores[player.id];
                        const Icon = player.icon;
                        return `
                          <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-lg">
                            <span class="text-2xl font-bold min-w-[30px]">
                              ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â'}
                            </span>
                            <div class="${player.color} p-2 rounded-lg">
                              ${Icon({ size: 24, className: 'text-white' })}
                            </div>
                            <div class="flex-1">
                              <p class="font-semibold text-gray-800">${player.name}</p>
                              <p class="text-sm ${lifetimeScore > 0 ? 'text-red-600' : lifetimeScore < 0 ? 'text-green-600' : 'text-gray-500'}">
                                ${lifetimeScore > 0 ? `${lifetimeScore} sass points accumulated` : lifetimeScore < 0 ? `${Math.abs(lifetimeScore)} credit earned!` : 'Perfectly balanced'}
                              </p>
                            </div>
                            <span class="text-3xl font-bold ${lifetimeScore > 0 ? 'text-red-600' : lifetimeScore < 0 ? 'text-green-600' : 'text-gray-600'}">
                              ${lifetimeScore > 0 ? '+' : ''}${lifetimeScore}
                            </span>
                          </div>
                        `;
                      }).join('')}
                  </div>
                </div>

                <!-- Total Events -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                  <h3 class="text-xl font-bold text-gray-800 mb-4">üìä Overall Stats</h3>
                  <div class="grid grid-cols-2 gap-4">
                    <div class="bg-red-50 rounded-lg p-4 text-center">
                      <div class="text-3xl font-bold text-red-600">
                        ${state.data.events.filter(e => e.value > 0 && !e.reverted).length}
                      </div>
                      <div class="text-sm text-red-800 mt-1">Sass Events</div>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4 text-center">
                      <div class="text-3xl font-bold text-green-600">
                        ${state.data.events.filter(e => e.value < 0 && !e.reverted && !e.isRevertLog).length}
                      </div>
                      <div class="text-sm text-green-800 mt-1">Apolo-Sass</div>
                    </div>
                    <div class="bg-yellow-50 rounded-lg p-4 text-center">
                      <div class="text-3xl font-bold text-yellow-600">
                        ${state.data.events.filter(e => e.reverted).length}
                      </div>
                      <div class="text-sm text-yellow-800 mt-1">Reverted</div>
                    </div>
                    <div class="bg-blue-50 rounded-lg p-4 text-center">
                      <div class="text-3xl font-bold text-blue-600">
                        ${state.data.payoffs.length}
                      </div>
                      <div class="text-sm text-blue-800 mt-1">Payoffs Completed</div>
                    </div>
                  </div>
                </div>

                <!-- Payouts & Rounds History -->
                ${state.data.snapshots.length > 0 ? `
                  <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">üèÅ Payouts & Rounds</h3>
                    <div class="space-y-3">
                      ${state.data.snapshots.slice(0, 10).map(snapshot => {
                        const sortedPlayers = [...players].sort((a, b) => 
                          snapshot.totals[a.id] - snapshot.totals[b.id]
                        );
                        const winner = sortedPlayers[0];
                        
                        return `
                          <div class="border border-gray-200 rounded-lg p-4">
                            <div class="flex items-start justify-between mb-3">
                              <div>
                                <p class="font-semibold text-gray-800">üìÖ ${snapshot.label}</p>
                                <p class="text-xs text-gray-500">${formatDateTime(snapshot.timestamp)}</p>
                              </div>
                              <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded-full">
                                Round ${state.data.snapshots.indexOf(snapshot) + 1}
                              </span>
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                              ${players.map(player => {
                                const score = snapshot.totals[player.id];
                                const isWinner = player.id === winner.id;
                                return `
                                  <div class="text-center p-2 rounded ${isWinner ? 'bg-yellow-50 border border-yellow-200' : 'bg-gray-50'}">
                                    ${isWinner ? '<div class="text-lg mb-1">üëë</div>' : ''}
                                    <div class="text-xs font-semibold text-gray-700">${player.name}</div>
                                    <div class="text-lg font-bold ${score > 0 ? 'text-red-600' : score < 0 ? 'text-green-600' : 'text-gray-600'}">
                                      ${score > 0 ? '+' : ''}${score}
                                    </div>
                                  </div>
                                `;
                              }).join('')}
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>
                ` : ''}

                <!-- Grunt Stats (Rick Ross Vibes!) -->
                ${state.data.grunts.length > 0 ? `
                  <div class="bg-gradient-to-r from-yellow-400 via-orange-400 to-red-400 rounded-xl p-1 shadow-lg">
                    <div class="bg-gray-900 rounded-lg p-6">
                      <h3 class="text-xl font-black text-yellow-400 mb-4 flex items-center justify-center gap-2">
                        üé§ GRUNT LEADERBOARD üé§
                      </h3>
                      <div class="space-y-2">
                        ${players.map(player => {
                          const playerGrunts = state.data.grunts.filter(g => g.playerId === player.id);
                          const gruntCounts = {};
                          gruntTypes.forEach(gt => {
                            gruntCounts[gt.id] = playerGrunts.filter(g => g.gruntId === gt.id).length;
                          });
                          const totalGrunts = playerGrunts.length;
                          
                          return `
                            <div class="bg-gray-800 rounded-lg p-3">
                              <div class="flex items-center justify-between mb-2">
                                <span class="font-bold text-white">${player.name}</span>
                                <span class="text-xl font-black text-yellow-400">${totalGrunts} GRUNTS</span>
                              </div>
                              <div class="flex gap-2 flex-wrap">
                                ${gruntTypes.map(gt => 
                                  gruntCounts[gt.id] > 0 ? `
                                    <span class="text-xs bg-gray-700 text-white px-2 py-1 rounded">
                                      ${gt.emoji} ${gruntCounts[gt.id]}
                                    </span>
                                  ` : ''
                                ).join('')}
                              </div>
                            </div>
                          `;
                        }).join('')}
                      </div>
                      
                      ${state.data.grunts.length > 0 ? `
                        <div class="mt-4 p-3 bg-gray-800 rounded-lg">
                          <p class="text-xs text-yellow-200 text-center font-semibold">
                            RECENT GRUNTS:
                          </p>
                          <div class="space-y-1 mt-2">
                            ${state.data.grunts.slice(0, 5).map(grunt => {
                              const player = players.find(p => p.id === grunt.playerId);
                              return `
                                <div class="flex items-center justify-between text-xs">
                                  <span class="text-white">${player?.name}</span>
                                  <span class="text-yellow-300 font-bold">${grunt.emoji} ${grunt.sound}</span>
                                  <span class="text-gray-400">${grunt.time}</span>
                                </div>
                              `;
                            }).join('')}
                          </div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                ` : ''}

                <!-- Best Day -->
                ${(() => {
                  const dates = [...new Set(state.data.events.filter(e => !e.reverted).map(e => e.date))];
                  if (dates.length === 0) return '';
                  
                  const dailyScores = dates.map(date => {
                    const dayEvents = state.data.events.filter(e => e.date === date && !e.reverted);
                    const totalSass = dayEvents.reduce((sum, e) => sum + e.value, 0);
                    return { date, totalSass };
                  });
                  
                  const bestDay = dailyScores.reduce((best, day) => 
                    day.totalSass < best.totalSass ? day : best
                  );
                  
                  return `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                      <h3 class="text-xl font-bold text-gray-800 mb-4">üåü Best Day Ever</h3>
                      <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg p-6 text-center">
                        <div class="text-5xl mb-2">üéâ</div>
                        <div class="text-2xl font-bold text-green-800 mb-1">
                          ${new Date(bestDay.date + 'T00:00:00').toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                        </div>
                        <div class="text-lg text-green-700">
                          ${bestDay.totalSass < 0 ? `${Math.abs(bestDay.totalSass)} net apolo-sass!` : bestDay.totalSass === 0 ? 'Perfect balance!' : `Only ${bestDay.totalSass} sass points`}
                        </div>
                      </div>
                    </div>
                  `;
                })()}
              </div>
            ` : ''}

            ${state.activeTab === 'history' ? `
              <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Payoff History</h3>
                ${state.data.payoffs.length > 0 ? `
                  <div class="space-y-3">
                    ${state.data.payoffs.map(payoff => {
                      const player = players.find(p => p.id === payoff.playerId);
                      return `
                        <div class="border border-gray-200 rounded-lg p-4">
                          <div class="flex items-center justify-between">
                            <div>
                              <p class="font-semibold text-gray-800">${player?.name} - ${payoff.consequenceName}</p>
                              <p class="text-sm text-gray-500">${formatDateTime(payoff.timestamp)}</p>
                            </div>
                            <span class="text-lg font-bold text-green-600">-${payoff.cost}</span>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : `
                  <div class="text-center py-12">
                    <div class="text-5xl mb-4">üìú</div>
                    <p class="text-gray-600">No payoffs yet!</p>
                  </div>
                `}
              </div>
            ` : ''}

            <!-- Note Modal with Quick Select Grid -->
            ${state.noteModal ? `
              <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                      ${state.noteModal.value > 0 ? 'üî• Add Sass Event' : '‚≠ê Add Apolo-Sass'}
                    </h3>
                    <button 
                      onclick="closeNoteModal()"
                      class="text-gray-400 hover:text-gray-600 text-2xl leading-none"
                    >√ó</button>
                  </div>

                  <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <div class="flex items-center justify-center gap-3 text-lg">
                      <span class="font-bold text-purple-600">
                        ${players.find(p => p.id === state.currentUser)?.name}
                      </span>
                      <span class="text-gray-400">‚Üí</span>
                      <span class="font-bold ${state.noteModal.value > 0 ? 'text-red-500' : 'text-green-500'}">
                        ${state.noteModal.value > 0 ? '+1' : '‚àí1'}
                      </span>
                      <span class="text-gray-400">‚Üí</span>
                      <span class="font-bold text-gray-800">
                        ${players.find(p => p.id === state.noteModal.receiverId)?.name}
                      </span>
                    </div>
                  </div>

                  <!-- Category Tabs -->
                  <div class="flex gap-2 mb-4 overflow-x-auto">
                    ${state.noteModal.value > 0 ? `
                      <button
                        onclick="selectCategory('top5')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'top5' 
                            ? 'bg-red-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        ‚≠ê Top 5
                      </button>
                      <button
                        onclick="selectCategory('attitude')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'attitude' 
                            ? 'bg-red-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        üò§ Attitude
                      </button>
                      <button
                        onclick="selectCategory('rules')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'rules' 
                            ? 'bg-red-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        üö´ Rules
                      </button>
                      <button
                        onclick="selectCategory('conflict')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'conflict' 
                            ? 'bg-red-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        ü•ä Conflict
                      </button>
                      <button
                        onclick="selectCategory('responsibility')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'responsibility' 
                            ? 'bg-red-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        üóëÔ∏è Tasks
                      </button>
                    ` : `
                      <button
                        onclick="selectCategory('top5')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'top5' 
                            ? 'bg-green-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        ‚≠ê Top 5
                      </button>
                      <button
                        onclick="selectCategory('helping')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'helping' 
                            ? 'bg-green-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        ü§ù Helping
                      </button>
                      <button
                        onclick="selectCategory('responsibility')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'responsibility' 
                            ? 'bg-green-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        ‚úÖ Tasks
                      </button>
                      <button
                        onclick="selectCategory('attitude')"
                        class="px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap ${
                          state.selectedCategory === 'attitude' 
                            ? 'bg-green-500 text-white' 
                            : 'bg-gray-100 text-gray-700'
                        }"
                      >
                        üòá Attitude
                      </button>
                    `}
                  </div>

                  <!-- Quick Select Grid -->
                  <div class="mb-4">
                    <p class="text-sm text-gray-600 mb-2 font-semibold">
                      üëÜ Pick a reason (optional custom note below)
                    </p>
                    <div class="grid grid-cols-2 gap-3">
                      ${(state.noteModal.value > 0 
                        ? quickReasons.sass[state.selectedCategory] 
                        : quickReasons.good[state.selectedCategory]
                      ).map(reason => `
                        <button
                          onclick="selectReason('${reason.label}')"
                          class="p-4 border-2 rounded-lg transition-all ${
                            state.selectedReason === reason.label
                              ? 'border-purple-500 bg-purple-50'
                              : 'border-gray-200 hover:border-purple-300 hover:bg-gray-50'
                          }"
                        >
                          <div class="text-3xl mb-1">${reason.emoji}</div>
                          <div class="text-sm font-semibold text-gray-800">${reason.label}</div>
                        </button>
                      `).join('')}
                    </div>
                  </div>

                  <!-- Optional Custom Note -->
                  <div class="border-t pt-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      üí¨ Add Details (Optional)
                    </label>
                    <textarea
                      id="noteTextarea"
                      placeholder="e.g., 'at dinner table' or 'helped put away toys'"
                      class="w-full p-3 border rounded-lg h-20 resize-none text-sm"
                      maxlength="100"
                    >${state.note}</textarea>
                    <p class="text-xs text-gray-500 mt-1">
                      üí° Add details to any preset reason or use custom note only
                    </p>
                  </div>

                  <div class="flex gap-3 mt-4">
                    <button
                      onclick="closeNoteModal()"
                      class="flex-1 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300"
                    >
                      Cancel
                    </button>
                    <button
                      onclick="saveNoteWithCustom()"
                      class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-lg"
                    >
                      ${state.selectedReason ? `Save "${state.selectedReason}"` : 'Save with Custom Note'}
                    </button>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Payout Modal -->
            ${state.showPayoutModal ? `
              <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-white rounded-xl p-6 max-w-md w-full">
                  <h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">üèÅ End Round & Payout</h3>
                  
                  <div class="bg-gradient-to-r from-purple-100 to-pink-100 rounded-lg p-4 mb-4">
                    <p class="text-sm text-gray-700 text-center mb-3">
                      Current scores will be saved and all meters will reset to 0 for a fresh start!
                    </p>
                    
                    <div class="space-y-2">
                      ${players.map(player => {
                        const score = currentScores[player.id];
                        const Icon = player.icon;
                        return `
                          <div class="flex items-center justify-between bg-white rounded-lg p-3">
                            <div class="flex items-center gap-2">
                              <div class="${player.color} p-2 rounded-lg">
                                ${Icon({ size: 20, className: 'text-white' })}
                              </div>
                              <span class="font-semibold text-gray-800">${player.name}</span>
                            </div>
                            <span class="text-xl font-bold ${score > 0 ? 'text-red-600' : score < 0 ? 'text-green-600' : 'text-gray-600'}">
                              ${score > 0 ? '+' : ''}${score}
                            </span>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </div>

                  <div class="mb-4">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">
                      Round Name (Optional)
                    </label>
                    <input
                      type="text"
                      id="payoutLabelInput"
                      value="${state.payoutLabel}"
                      placeholder="e.g., 'Friday Movie Night', 'Weekend Round'"
                      class="w-full p-3 border rounded-lg"
                      maxlength="50"
                    />
                    <p class="text-xs text-gray-500 mt-1">
                      üí° Examples: "End of Weekend", "School Week", "Vacation Round"
                    </p>
                  </div>

                  <div class="flex gap-3">
                    <button
                      onclick="closePayoutModal()"
                      class="flex-1 py-3 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300"
                    >
                      Cancel
                    </button>
                    <button
                      onclick="confirmPayout()"
                      class="flex-1 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg font-semibold hover:shadow-lg"
                    >
                      üèÅ End Round
                    </button>
                  </div>
                </div>
              </div>
            ` : ''}

            <!-- Grunt Modal (Rick Ross Style!) -->
            ${state.showGruntModal ? `
              <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div class="bg-gradient-to-br from-yellow-400 via-orange-400 to-red-400 rounded-xl p-1 max-w-md w-full shadow-2xl">
                  <div class="bg-gray-900 rounded-lg p-6">
                    <h3 class="text-3xl font-black text-yellow-400 mb-2 text-center" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                      üé§ DROP A GRUNT üé§
                    </h3>
                    <p class="text-sm text-yellow-200 text-center mb-4">RICK ROSS STYLE - NO SASS POINTS, JUST VIBES!</p>
                    
                    <div class="grid grid-cols-2 gap-3 mb-4">
                      ${gruntTypes.map(grunt => `
                        <button
                          onclick="selectGrunt('${state.showGruntModal}', ${JSON.stringify(grunt).replace(/"/g, '&quot;')})"
                          class="bg-gradient-to-r ${grunt.color} p-4 rounded-lg hover:scale-105 transition-transform border-2 border-white shadow-lg"
                        >
                          <div class="text-4xl mb-1">${grunt.emoji}</div>
                          <div class="text-xl font-black text-white" style="text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">
                            ${grunt.sound}
                          </div>
                          <div class="text-xs text-white font-semibold mt-1">${grunt.label}</div>
                        </button>
                      `).join('')}
                    </div>

                    <button
                      onclick="closeGruntModal()"
                      class="w-full py-3 bg-gray-700 text-white rounded-lg font-semibold hover:bg-gray-600"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    };

    // Global Functions
    window.connectToRoom = () => {
      const input = document.getElementById('roomIdInput');
      state.roomId = input.value.trim();
      if (!state.roomId) return;
      state.isConnected = true;
      initFirebase();
      render();
    };

    window.skipFirebase = () => {
      state.roomId = 'local-only';
      state.isConnected = false;
      // Keep showing user selector so they can choose who they are
      state.showUserSelect = true;
      state.currentUser = null;
      render();
    };

    window.selectUser = (userId) => {
      state.currentUser = userId;
      state.showUserSelect = false;
      render();
    };

    window.switchUser = () => {
      state.showUserSelect = true;
      render();
    };

    window.switchTab = (tab) => {
      state.activeTab = tab;
      render();
    };

    window.openNoteModal = (receiverId, value) => {
      // Block self-sass!
      if (state.currentUser === receiverId) {
        alert('üö´ ILLEGAL MOVE! üö´\n\nYou cannot give sass or apolo-sass to yourself!\n\nNice try though! üòè');
        return;
      }
      
      state.noteModal = { receiverId, value };
      state.selectedCategory = 'top5'; // Always start with top 5
      render();
    };

    window.closeNoteModal = () => {
      state.noteModal = null;
      state.note = '';
      state.selectedReason = '';
      state.selectedCategory = 'top5';
      render();
    };

    window.selectCategory = (category) => {
      state.selectedCategory = category;
      render();
    };

    window.selectReason = (reason) => {
      state.selectedReason = state.selectedReason === reason ? '' : reason;
      render();
    };

    window.saveNote = () => {
      const textarea = document.getElementById('noteTextarea');
      const note = textarea ? textarea.value : '';
      handleAddSassEvent(state.noteModal.receiverId, state.noteModal.value, note, state.selectedReason);
    };

    window.saveNoteWithCustom = () => {
      const textarea = document.getElementById('noteTextarea');
      const note = textarea ? textarea.value : '';
      handleAddSassEvent(state.noteModal.receiverId, state.noteModal.value, note, state.selectedReason);
    };

    window.payOffSass = (playerId, consequence) => {
      handlePayOffSass(playerId, consequence);
    };

    window.openPayoffModal = (playerId) => {
      state.payoffModal = playerId;
      state.activeTab = 'payoff';
      render();
    };

    window.openPayoutModal = () => {
      state.showPayoutModal = true;
      render();
    };

    window.closePayoutModal = () => {
      state.showPayoutModal = false;
      state.payoutLabel = '';
      render();
    };

    window.confirmPayout = () => {
      const input = document.getElementById('payoutLabelInput');
      const label = input ? input.value.trim() : '';
      handleMakePayout(label || `Round ${state.data.snapshots.length + 1}`);
    };

    window.openGruntModal = (playerId) => {
      state.showGruntModal = playerId;
      render();
    };

    window.closeGruntModal = () => {
      state.showGruntModal = false;
      render();
    };

    window.selectGrunt = (playerId, gruntType) => {
      handleAddGrunt(playerId, gruntType);
    };

    window.revertSassEvent = (eventId) => {
      handleRevertSassEvent(eventId);
    };

    document.addEventListener('input', (e) => {
      if (e.target.id === 'roomIdInput') state.roomId = e.target.value;
      if (e.target.id === 'noteTextarea') state.note = e.target.value;
      if (e.target.id === 'payoutLabelInput') state.payoutLabel = e.target.value;
    });

    render();
  </script>
</body>
</html>
